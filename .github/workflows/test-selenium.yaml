name: Test Management UI with Selenium
on:
  push:
    branches:
    - pjk25/oidc-integration-github-action
jobs:
  selenimum:
    runs-on: ubuntu-latest
    #! container:
    #!   image: node:16
    services:
      selenium:
        image: selenium/standalone-${{ matrix.browser }}
    strategy:
      fail-fast: false
      matrix:
        erlang_major:
        - "24"
        #! - "25"
        browser:
        - chrome
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - uses: actions/setup-node@v2
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: deps/rabbitmq_management/selenium/package.json

    - name: npm install
      working-directory: deps/rabbitmq_management/selenium
      run: npm i

    - name: Test
      env:
        BROWSER: ${{ matrix.browser }}
      working-directory: deps/rabbitmq_management/selenium
      run: npm run test

    #! - name: Build mocha-test
    #!   run: |
    #!     cd deps/rabbitmq_management/selenium
    #!     make init-tests
    #!     docker images | grep mocha-test
    #! - name: Call mocha-test
    #!   run: |
    #!     cd deps/rabbitmq_management/selenium
    #!     source bin/rabbitmq.sh
    #!     echo "running RabbitMQ..."
    #!     RABBITMQ_CONFIG=$PWD/test/oauth/with-uaa/rabbitmq.config start_rabbitmq
    #!     sleep 5
    #!     docker exec -it local-rabbitmq rabbitmqctl await_startup
    #!     make run-tests


####
# We need to run these as docker images:
#  UAA
#  RabbitMQ
#  Selenium Tests (maybe these ones could run in the host machine)
#  Selenium Hub (which runs the browser in silent mode)

# The workflow is more or less like this:
# job:build-rabbitmq-image  -> job:build-test-runner-image -> job:run-tests

# job:build-rabbitmq-image : Ideally, we do not want to push it. can we do that in github actions?
#
# job:run-tests : It runs within a container and it uses these services:
#  - rabbitmq
#  - UAA
#  - selenium-hub
# and it has this step which uses the image test-runner built by the job build-test-runner-image
